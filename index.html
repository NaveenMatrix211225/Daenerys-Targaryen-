<!DOCTYPE html>

<html lang="en">

<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>MARVEL</title>



  <!-- Google Fonts -->

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">



  <style>

    body {

      margin: 0;

      padding: 0;

      font-family: 'Orbitron', sans-serif;

      text-align: center;

      min-height: 100vh;

      color: #fff;

      background: #000;

      transition: background 1s;

    }

    h1 { margin: 20px 0; font-size: 2.5rem; letter-spacing: 2px; }

    .container {

      background: rgba(0,0,0,0.75);

      padding: 20px;

      border-radius: 18px;

      max-width: 950px;

      margin: auto;

      box-shadow: 0 0 25px #ff0000;

    }

    select { margin: 10px; padding: 8px; border-radius: 8px; font-weight: bold; }

    table { width: 100%; border-collapse: collapse; margin-top: 15px; }

    th, td { padding: 10px; border: 1px solid #999; }

    button {

      margin: 5px; padding: 10px 15px;

      border-radius: 10px; cursor: pointer;

      font-weight: bold; border: none;

    }

    button:hover { transform: scale(1.08); }



    /* Login box */

    #loginForm {

      margin-top: 100px;

    }

  </style>

</head>

<body class="ironman">



  <!-- 🔐 Login Form -->

  <div id="loginForm">

    <h2>Login</h2>

    <input type="email" id="email" placeholder="Email" required><br><br>

    <input type="password" id="password" placeholder="Password" required><br><br>

    <button onclick="loginUser()">Login</button>

  </div>



  <!-- 🔓 App Content (hidden until login) -->

  <div id="app" style="display:none;">

    <button onclick="logoutUser()">Logout</button>



    <!-- ===== Your Original App ===== -->

    <h1>AVENGERS ASSEMBLE</h1>



    <!-- Theme Switcher -->

    <label for="themeSelect"><b>Choose Theme:</b></label>

    <select id="themeSelect">

      <option value="ironman">Iron Man</option>

      <option value="captain">Captain America</option>

      <option value="thor">Thor</option>

      <option value="hulk">Hulk</option>

      <option value="panther">Black Panther</option>

      <option value="strange">Doctor Strange</option>

      <option value="spiderman">Spider-Man</option>

      <option value="guardians">Guardians</option>

      <option value="avengers">Avengers</option>

      <option value="thanos">Thanos</option>

    </select>



    <div class="container">

      <input type="file" id="fileInput" accept=".xlsx, .xls">

      <div>

        <button id="generateBtn" onclick="processFile()" disabled>Generate Links</button>

        <button onclick="clearData()">Clear All</button>

      </div>

      <div>

        <button id="copyAllBtn" onclick="copyAllLinks()" disabled>Copy All Links</button>

        <button onclick="exportToCSV()" id="exportBtn" disabled>Export to CSV</button>

      </div>

      <table id="linkTable">

        <thead>

          <tr><th>Receipt No.</th><th>Sales Type</th><th>Generated Link</th><th>Action</th></tr>

        </thead>

        <tbody></tbody>

      </table>

    </div>

    <!-- ===== End Original App ===== -->

  </div>



  <!-- Firebase SDK -->

  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";

    import { getAuth, signInWithEmailAndPassword, signOut }

      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";



    // 🔑 Your Firebase Config

    const firebaseConfig = {

      apiKey: "AIzaSyB8BBrmeDQ2aTK7OU0Yqtxndv9aX10qLdA",

      authDomain: "daenerys-targaryen-9cbbc.firebaseapp.com",

      projectId: "daenerys-targaryen-9cbbc",

      storageBucket: "daenerys-targaryen-9cbbc.firebasestorage.app",

      messagingSenderId: "1019585641365",

      appId: "1:1019585641365:web:1b6293bd6a4f6dc421d49c",

      measurementId: "G-8480C186JX"

    };



    const app = initializeApp(firebaseConfig);

    const auth = getAuth(app);



    // Login

    async function loginUser() {

      const email = document.getElementById("email").value;

      const password = document.getElementById("password").value;

      try {

        await signInWithEmailAndPassword(auth, email, password);

        document.getElementById("loginForm").style.display = "none";

        document.getElementById("app").style.display = "block";

      } catch (error) {

        alert("Error: " + error.message);

      }

    }



    // Logout

    async function logoutUser() {

      await signOut(auth);

      document.getElementById("loginForm").style.display = "block";

      document.getElementById("app").style.display = "none";

    }



    window.loginUser = loginUser;

    window.logoutUser = logoutUser;

  </script>



  <!-- XLSX library -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>

    /* === Your Original App JS (untouched) === */

    let currentData = [];

    const storeID = "91KDIPL879-01";



    function convertExcelDate(serial) {

      const date = new Date((serial - 25569) * 86400 * 1000);

      return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;

    }

    function convertExcelTime(serial) {

      const totalMilliseconds = Math.round(serial * 24 * 60 * 60 * 1000);

      const hours = String(Math.floor(totalMilliseconds / (60 * 60 * 1000))).padStart(2,'0');

      const minutes = String(Math.floor((totalMilliseconds % (60 * 60 * 1000)) / (60 * 1000))).padStart(2,'0');

      const seconds = String(Math.floor((totalMilliseconds % (60 * 1000)) / 1000)).padStart(2,'0');

      return `${hours}:${minutes}:${seconds}`;

    }



    function generateSurveyLink(row) {

      const receiptNo = row['Receipt No.'];

      const salesType = row['Sales Type'];

      let surveyModel = '', orderID = '', numericOT = '';



      if (/^\d+$/.test(receiptNo) && salesType === 'TAKEAWAY') { surveyModel = '6.0'; orderID = receiptNo; numericOT = '2'; }

      else if (/^\d+$/.test(receiptNo) && salesType === 'DINE-IN') { surveyModel = '6.0'; orderID = receiptNo; numericOT = '1'; }

      else if (receiptNo.startsWith('K281') && salesType === 'TAKEAWAY') { surveyModel = '4.0'; orderID = receiptNo.slice(-4); numericOT = '2'; }

      else if (receiptNo.startsWith('K281') && salesType === 'DINE-IN') { surveyModel = '4.0'; orderID = receiptNo.slice(-4); numericOT = '1'; }

      else if (receiptNo.startsWith('K281') && salesType === 'DELIVERY') { surveyModel = '3.0'; orderID = receiptNo; numericOT = '3'; }

      else { return null; }



      const date = convertExcelDate(row['Date']);

      const time = convertExcelTime(row['Time']);

      const phoneNumber = `91${row['Sell-to Contact No.']}`;

      const isoDateTime = `${date}T${time}Z`;



      const data = { "S": storeID, "OI": orderID, "D": date, "TM": time, "DTM": isoDateTime, "TI": orderID, "OT": numericOT, "SM": surveyModel, "PH": phoneNumber };

      const encodedData = btoa(JSON.stringify(data));

      return `https://customer.kfc-listens.com/jfe/form/SV_8bHC0noyvM3jPWC?Q_EED=${encodedData}`;

    }



    document.getElementById('fileInput').addEventListener('change', function() {

      document.getElementById('generateBtn').disabled = false;

    });



    function processFile() {

      const file = document.getElementById('fileInput').files[0];

      if (!file) return;



      const reader = new FileReader();

      reader.onload = function(e) {

        const data = new Uint8Array(e.target.result);

        const workbook = XLSX.read(data, { type: 'array' });

        const sheetName = workbook.SheetNames[0];

        const sheet = workbook.Sheets[sheetName];

        const rows = XLSX.utils.sheet_to_json(sheet);



        currentData = rows.map(row => {

          const link = generateSurveyLink(row);

          return { ...row, link };

        });



        renderTable();

      };

      reader.readAsArrayBuffer(file);

    }



    function renderTable() {

      const tbody = document.querySelector("#linkTable tbody");

      tbody.innerHTML = '';

      currentData.forEach((row) => {

        if (row.link) {

          const tr = document.createElement('tr');

          tr.innerHTML = `

            <td>${row['Receipt No.']}</td>

            <td>${row['Sales Type']}</td>

            <td><a href="${row.link}" target="_blank">Open Link</a></td>

            <td><button onclick="copyLink('${row.link}')">Copy</button></td>

          `;

          tbody.appendChild(tr);

        }

      });

      document.getElementById('copyAllBtn').disabled = false;

      document.getElementById('exportBtn').disabled = false;

    }



    function clearData() {

      currentData = [];

      document.querySelector("#linkTable tbody").innerHTML = '';

      document.getElementById('copyAllBtn').disabled = true;

      document.getElementById('exportBtn').disabled = true;

    }



    function copyLink(link) {

      navigator.clipboard.writeText(link).then(() => {

        alert("Link copied!");

      });

    }



    function copyAllLinks() {

      const allLinks = currentData.map(r => r.link).join("\n");

      navigator.clipboard.writeText(allLinks).then(() => {

        alert("All links copied!");

      });

    }



    function exportToCSV() {

      let csv = "Receipt No.,Sales Type,Generated Link\n";

      currentData.forEach(r => {

        if (r.link) {

          csv += `${r['Receipt No.']},${r['Sales Type']},${r.link}\n`;

        }

      });

      const blob = new Blob([csv], { type: 'text/csv' });

      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');

      a.href = url;

      a.download = "survey_links.csv";

      a.click();

    }



    // Theme Switcher

    const themeSelect = document.getElementById("themeSelect");

    themeSelect.addEventListener("change", function() {

      document.body.className = this.value;

    });

  </script>

</body>

</html>
